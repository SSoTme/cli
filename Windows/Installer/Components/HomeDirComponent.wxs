<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Fragment>
    <!-- Embed the script as a binary resource -->
    <Binary Id="CreateSsotmeHomedirPs1" SourceFile="Scripts\CreateSsotmeHomedir.ps1" />

    <!-- Instead of trying to use Binary directly (which is problematic in WiX v3),
         copy the script to a temporary file as part of installation -->
    <DirectoryRef Id="TARGETDIR">
      <Directory Id="TempFolder">
        <Component Id="TempScriptComponent" Guid="*">
          <File Id="TempScriptFile" Source="Scripts\CreateSsotmeHomedir.ps1" Temporary="yes" />
        </Component>
      </Directory>
    </DirectoryRef>

    <!-- Reference the temp file directly, which works with [#FileId] syntax -->
    <CustomAction Id="SetHomeSsotmeScriptData"
                  Property="HomeSsotmeScript"
                  Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -File &quot;[#TempScriptFile]&quot; &quot;[INSTALLFOLDER]&quot;"
                  Execute="immediate" />

    <CustomAction Id="HomeSsotmeScript"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <!-- ComponentGroup to include our temp component -->
    <ComponentGroup Id="HomeSsotmeScriptComponents">
      <ComponentRef Id="TempScriptComponent" />
    </ComponentGroup>

    <InstallExecuteSequence>
      <Custom Action="SetHomeSsotmeScriptData" Before="InstallFinalize">NOT SSOTMEHOME_INSTALLED</Custom>
      <Custom Action="HomeSsotmeScript" After="SetHomeSsotmeScriptData">NOT SSOTMEHOME_INSTALLED</Custom>
    </InstallExecuteSequence>
  </Fragment>
</Wix>