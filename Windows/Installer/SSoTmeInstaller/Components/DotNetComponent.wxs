<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  
  <!-- Constants for .NET installation -->
  <?define DotNetBaseVersion = "7.0" ?>
  <?define Architecture = "x64" ?>
  <?define DotNetDownloadUrl = "https://dotnet.microsoft.com/en-us/download/dotnet/thank-you/sdk-$(var.DotNetVersion)-windows-$(var.Architecture)-installer" ?>
  
  <Fragment>
    <!-- .NET SDK detection properties -->
    <Property Id="DOTNET_INSTALLED" Secure="yes">
      <RegistrySearch Id="DotNetCoreSDKSearch"
                     Root="HKLM"
                     Key="SOFTWARE\dotnet\Setup\InstalledVersions\x64\sdk"
                     Name="$(var.DotNetVersion)"
                     Type="raw" />
    </Property>

    <CustomAction Id="SetDotNetInstallerPath"
                  Property="DOTNET_INSTALLER_PATH"
                  Value="[TempFolder]$(var.DotNetDownloadUrl)" />

    <SetProperty Id="DownloadDotNet"
                Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;[#DownloadScript]&quot;"
                Before="DownloadDotNet"
                Sequence="execute">
      NOT DOTNET_INSTALLED
    </SetProperty>

    <CustomAction Id="SetHomeSsotmeScriptData"
                  Property="HomeSsotmeScript"
                  Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]CreateSsotmeHomedir.ps1&quot; &quot;[INSTALLFOLDER]&quot;"
                  Execute="immediate" />
    
    <CustomAction Id="DownloadDotNet"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="immediate"
                  Return="check" />

    <CustomAction Id="HomeSsotmeScript"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <SetProperty Id="InstallDotNet"
                Value="&quot;[TempFolder]$(var.DotNetDownloadUrl)&quot; /install /quiet /norestart"
                Before="InstallDotNet"
                Sequence="execute">
      NOT DOTNET_INSTALLED
    </SetProperty>
    
    <CustomAction Id="InstallDotNet"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <ComponentGroup Id="DotNetComponents" Directory="INSTALLFOLDER">
      <Component Id="DotNetDetection" Guid="*">
        <File Id="DownloadScript" Source="Scripts\DownloadDotNet.ps1" KeyPath="yes" />
        <Condition>NOT DOTNET_INSTALLED</Condition>
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="HomeSsotmeScript" Directory="INSTALLFOLDER">
      <Component Id="CopyToHomeComp" Guid="*">
        <File Id="CopyToHomeScript" Source="Scripts\CreateSsotmeHomedir.ps1" KeyPath="yes" />
        <Condition>NOT SSOTMEHOME_INSTALLED</Condition>
      </Component>
    </ComponentGroup>

    <InstallExecuteSequence>
      <Custom Action="DownloadDotNet" Before="InstallDotNet">NOT DOTNET_INSTALLED</Custom>
      <Custom Action="InstallDotNet" Before="InstallFinalize">NOT DOTNET_INSTALLED</Custom>

      <Custom Action="SetHomeSsotmeScriptData" After="InstallDotNet">NOT SSOTMEHOME_INSTALLED</Custom>
      <Custom Action="HomeSsotmeScript" After="SetHomeSsotmeScriptData">NOT SSOTMEHOME_INSTALLED</Custom>
    </InstallExecuteSequence>
  </Fragment>
</Wix>