/*******************************************
 Initially Generated by SSoT.me - codee42 & odxml42
 Created By: EJ Alexandra - 2017
             An Abstract Level, llc
 License:    Mozilla Public License 2.0
 *******************************************/
using System;
using System.ComponentModel;
using SassyMQ.SSOTME.Lib.RMQActors;
using System.IO;
using System.Diagnostics;
using SSoTme.OST.Lib.CLIOptions;
using SSoTme.OST.Lib.Extensions;
using SassyMQ.Lib.RabbitMQ;
using System.Text.RegularExpressions;

namespace SSoTme.OST.Lib.DataClasses
{
    public partial class ProjectTranspiler
    {
        public Transpiler MatchedTranspiler { get; set; }
        public SSoTmeCLIHandler CLIHandler { get; private set; }

        // Fields used by the my.effortlessapi tool marketplace that should get preserved during builds
        // CLI doesn't use these fields, just preserves if they exist
        public string MarketToolName { get; set; }
        public string LastUsed { get; set; }
        public string NumExecutions { get; set; }

        public ProjectTranspiler()
        {
            this.InitPoco();
        }

        public bool IsSSoTTranspiler { get; set; }

        public override string ToString()
        {
            var outputFileName = String.Empty;
            if (!ReferenceEquals(this.CLIHandler, null) && !ReferenceEquals(this.CLIHandler.OutputFileSet, null))
            {
                var outputFileSet = this.CLIHandler.OutputFileSet;
                if (!ReferenceEquals(outputFileSet, null) && System.Linq.Enumerable.Any(outputFileSet.FileSetFiles))
                {
                    outputFileName = String.Format(" ({0})", System.Linq.Enumerable.First(outputFileSet.FileSetFiles).RelativePath);
                }
            }
            var files = String.Format("{0}{1}", this.RelativePath, outputFileName).PadRight(40);
            return String.Format("{0} :: {1}", files, this.CommandLine);
        }

        public ProjectTranspiler(string relativePath, SSOTMEPayload result)
        : this()
        {
            bool localCommand = (ReferenceEquals(result, null));

            this.Name = localCommand ? "LocalCommand" : result.Transpiler.Name;

            this.RelativePath = relativePath.SafeToString().Replace("\\", "/");
            var lowerCLI = Environment.CommandLine.ToLower().Replace("\\", "/");
            var cmd0 = Environment.CommandLine;
            Console.WriteLine($"COMMAND LINE: {cmd0}");
            if (lowerCLI.Contains("/ssotme.exe")) cmd0 = cmd0.Substring(lowerCLI.IndexOf("/ssotme.exe") + "/ssotme.exe".Length);
            else if (lowerCLI.Contains("/ssotme.ost.cli.dll")) cmd0 = cmd0.Substring(lowerCLI.IndexOf("/ssotme.ost.cli.dll") + "/ssotme.ost.cli.dll".Length);
            else if (lowerCLI.Contains("/aicapture.ost.cli.dll")) cmd0 = cmd0.Substring(lowerCLI.IndexOf("/aicapture.ost.cli.dll") + "/aicapture.ost.cli.dll".Length);            
            else if (lowerCLI.Contains("/ssotme")) cmd0 = cmd0.Substring(lowerCLI.IndexOf("/ssotme") + "/ssotme".Length);
            else if (lowerCLI.Contains("/aicapture")) cmd0 = cmd0.Substring(lowerCLI.IndexOf("/aicapture") + "/aicapture".Length);
            else if (lowerCLI.Contains("/aic")) cmd0 = cmd0.Substring(lowerCLI.IndexOf("/aic") + "/aic".Length);

            cmd0 = cmd0.Replace("-install", "").Replace(" install ", " ").Trim(" '\"".ToCharArray());
            this.CommandLine = cmd0;
            
            this.MatchedTranspiler = localCommand ? default(Transpiler) : result.Transpiler;
        }

        internal void Rebuild(SSoTmeProject project)
        {
            Console.WriteLine("\n\n **** " + this.RelativePath + ": " + this.Name + " ****");
            Console.WriteLine("CommandLine:> ssotme {0}", this.CommandLine);
            var transpileRootDI = new DirectoryInfo(Path.Combine(project.RootPath, $"{this.RelativePath}".Trim("\\/".ToCharArray())));
            if (!transpileRootDI.Exists) transpileRootDI.Create();

            Environment.CurrentDirectory = transpileRootDI.FullName;
            var cliHandler = SSoTmeCLIHandler.CreateHandler(this.CommandLine);
            var cliResult = cliHandler.TranspileProject(this);
            if (cliResult != 0) throw new Exception("Error RE-Transpiling");
        }

        internal void Clean(SSoTmeProject project, bool preserveZFS)
        {
            Console.WriteLine("CLEANING: " + this.RelativePath + ": " + this.Name);
            Console.WriteLine("CommandLine:> aicapture {0}", this.CommandLine);
            var di = new DirectoryInfo(Path.Combine(project.RootPath, this.RelativePath.Trim("\\/".ToCharArray())));
            if (!di.Exists) di.Create();
            Environment.CurrentDirectory = di.FullName;
            var zfsDI = project.GetZFSDI(this.RelativePath);

            // For remote transpilers, extract and sanitize the URL from command line
            string transpilerName;
            if (this.Name == "remote-transpiler" && this.CommandLine.Contains("-g "))
            {
                // Extract URL from "-g URL" in command line
                var parts = this.CommandLine.Split(' ');
                var gIndex = Array.IndexOf(parts, "-g");
                if (gIndex >= 0 && gIndex + 1 < parts.Length)
                {
                    var targetUrl = parts[gIndex + 1];
                    transpilerName = targetUrl.SanitizeUrlForFilename();
                }
                else
                {
                    transpilerName = this.Name.ToTitle().ToLower().Replace(" ", "-");
                }
            }
            else
            {
                transpilerName = this.MatchedTranspiler?.LowerHyphenName ?? this.Name.ToTitle().ToLower().Replace(" ", "-");
            }

            String zsfFileName = String.Format("{0}/{1}.zfs", zfsDI.FullName, transpilerName);
            // Console.WriteLine($"Using ZFS {zsfFileName}");
            var zfsFI = new FileInfo(zsfFileName);
            if (zfsFI.Exists)
            {
                var zippedFileSet = File.ReadAllBytes(zfsFI.FullName);
                zippedFileSet.CleanZippedFileSet();
                if (!preserveZFS) File.Delete(zfsFI.FullName);
            }
        }

        public void Describe(SSoTmeProject project)
        { 
            Console.WriteLine("\n-----------------------------------");
            Console.WriteLine("---- {0}{1}", this.Name, this.IsDisabled ? "    **** DISABLED ****" : "");
            Console.WriteLine("---- .{0}/", $"{this.RelativePath}".Replace("\\", "/"));
            Console.WriteLine("-----------------------------------");
            Console.WriteLine("\nCommand Line:> ssotme {0}\n", this.CommandLine);
        }

        public bool IsAtPath(string relativePath)
        {
            relativePath = relativePath.Replace("\\", "/").ToLower();

            return this.RelativePath
                       .SafeToString()
                       .Replace("\\", "/")
                       .ToLower()
                       .StartsWith(relativePath);
        }

        public void LoadInputAndOuputFiles(SSoTmeProject project, bool includeContents)
        {

            var cliHandler = SSoTmeCLIHandler.CreateHandler(this.CommandLine);
            if (!includeContents)
            {
                foreach (var fsf in cliHandler.FileSet.FileSetFiles)
                {
                    fsf.ClearContents();
                }
                cliHandler.inputFileSetXml = String.Empty;
                cliHandler.AICaptureProject = null;
            }

            if (!ReferenceEquals(this.MatchedTranspiler, null))
            {
                cliHandler.AICaptureProject = project;
                if (String.IsNullOrEmpty(this.MatchedTranspiler.LowerHyphenName))
                {
                    this.MatchedTranspiler.LowerHyphenName = $"{this.MatchedTranspiler.Name}".ToTitleCase().Replace(" ", "-").ToLower();
                }
                cliHandler.LoadOutputFiles(this.MatchedTranspiler.LowerHyphenName, this.GetProjectRelativePath(project), includeContents);
                cliHandler.AICaptureProject = null;
            }
            this.CLIHandler = cliHandler;
        }

        public String GetProjectRelativePath(SSoTmeProject project)
        {
            var fullPath = Path.Combine(project.RootPath, this.RelativePath.Trim("\\/".ToCharArray()));
            return fullPath.Substring(project.RootPath.Length).Replace("\\", "/");
        }
    }
}